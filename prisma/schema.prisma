generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Lead {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Customer Info
  name           String
  email          String
  phone          String
  alternatePhone String?
  address        String?
  city           String?
  state          String?
  zip            String?
  rating         Int?

  // Lead Info
  vehicleDate  DateTime?
  vehicleName  String?
  vehicleModel String?

  callStatus    CallStatus
  paymentStatus PaymentStatus

  LeadStatus   LeadStatus[]
  LeadFeedback LeadFeedback[]
  Feedbacks Feedbacks[]

  companyId String?  @db.ObjectId
  Company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([companyId])
}

enum CallStatus {
  BUSY
  PENDING
  SUCCESS
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

model LeadStatus {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?

  leadId String @unique @db.ObjectId
  Lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  deptId String?      @db.ObjectId
  Dept   CompanyDept? @relation(fields: [deptId], references: [id])

  assignedToId String? @db.ObjectId
  assignedTo   Member? @relation(fields: [assignedToId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assignedToId])
}

model LeadFeedback {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  deptId String?      @db.ObjectId
  dept   CompanyDept? @relation(fields: [deptId], references: [id])

  leadId String? @db.ObjectId
  lead   Lead?   @relation(fields: [leadId], references: [id])

  memberId String? @db.ObjectId
  member   Member? @relation(fields: [memberId], references: [id])

  feedback Feedbacks[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

   @@unique([leadId, memberId]) 
}

model Feedbacks {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  leadFeedbackId String?       @db.ObjectId
  LeadFeedback   LeadFeedback? @relation(fields: [leadFeedbackId], references: [id])

  leadId String? @db.ObjectId
  lead   Lead?   @relation(fields: [leadId], references: [id])

  name      String
  value     String
  fieldType String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AdminDept {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  name   String  @unique
  imgURL String?

  deptFields DeptField[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CompanyDept {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  name          String
  deptManagerId String

  companyId String?  @db.ObjectId
  Company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  companyDeptForms CompanyDeptForm[]
  leadStatus       LeadStatus[]
  members          Member[]

  LeadFeedback LeadFeedback[] // All Lead Feedbacks

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model DeptField {
  id   String @id @default(auto()) @map("_id") @db.ObjectId
  name String

  adminDeptId String?    @db.ObjectId
  AdminDept   AdminDept? @relation(fields: [adminDeptId], references: [id])

  SubDeptField SubDeptField[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([adminDeptId])
}

model SubDeptField {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  fieldType FieldType
  value     Json?

  deptFieldId String?    @db.ObjectId
  DeptField   DeptField? @relation(fields: [deptFieldId], references: [id])

  CompanyDeptForm   CompanyDeptForm? @relation(fields: [companyDeptFormId], references: [id])
  companyDeptFormId String?          @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deptFieldId])
}

enum FieldType {
  INPUT
  IMAGE
  TEXTAREA
  RADIO
  CHECKBOX
  SELECT
}

model CompanyDeptForm {
  id   String @id @default(auto()) @map("_id") @db.ObjectId
  name String

  companyDeptId String?      @db.ObjectId
  companyDept   CompanyDept? @relation(fields: [companyDeptId], references: [id])

  subDeptFields SubDeptField[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyDeptId])
}

model Company {
  id               String  @id @default(auto()) @map("_id") @db.ObjectId
  rootId           String
  companyManagerId String
  name             String
  imgURL           String?
  email            String
  phone            String

  isSubscribed Boolean @default(false)

  members Member[]      @relation("CompanyMembers")
  Depts   CompanyDept[]
  Leads   Lead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([rootId])
  @@index([companyManagerId])
  @@index([email])
}

model Role {
  id   String @id @default(auto()) @map("_id") @db.ObjectId
  name String

  Members Member[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Member {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  email    String  @unique
  password String
  name     String
  imgURL   String?
  phone    String

  deptId String?      @db.ObjectId
  Dept   CompanyDept? @relation(fields: [deptId], references: [id], onDelete: Cascade)

  roleId String @db.ObjectId
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  companyId String?  @db.ObjectId
  Company   Company? @relation(fields: [companyId], references: [id], name: "CompanyMembers", onDelete: Cascade)

  LeadStatuses LeadStatus[] // Assigned Lead Statuses
  LeadFeedback LeadFeedback[]

  sessionToken String? // Device Login Token at a time

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deptId])
  @@index([roleId])
  @@index([companyId])
}
